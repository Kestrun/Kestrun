permissions:
    contents: read
    pull-requests: read

name: CI (core)

on:
    workflow_call:
        inputs:
            is_pr:
                description: Whether the workflow runs for a pull request context.
                required: true
                type: boolean
            debug:
                description: Enable debug logging when invoked manually.
                required: false
                default: false
                type: boolean

concurrency:
    group: ci-${{ github.repository }}-${{ inputs.is_pr && github.event.pull_request.number || github.ref }}
    cancel-in-progress: true

jobs:
    lint:
        name: Linting
        uses: Kestrun/Kestrun/.github/workflows/lint-core.yml@main
        with:
            is_pr: ${{ inputs.is_pr }}

    build:
        needs: lint
        strategy:
            fail-fast: false
            matrix:
                os:
                    [
                        ubuntu-24.04,
                        ubuntu-22.04,
                        macos-15,
                        macos-14,
                        windows-2022,
                        windows-2025,
                        ubuntu-24.04-arm,
                        windows-11-arm,
                    ]
                pwsh: ["7.4.12", "latest", "preview"]
        runs-on: ${{ matrix.os }}

        defaults:
            run:
                working-directory: ${{ github.workspace }}

        env:
            POWERSHELL_DISTRIBUTION_CHANNEL: GitHub-Actions
            ACTIONS_STEP_DEBUG: ${{ inputs.debug && 'true' || '' }} 
            UPSTASH_REDIS_URL: ${{ secrets.UPSTASH_REDIS_URL || 'redis://default:AVjCAAIncDIyNzhjYTkxY2VmYTM0ZDBkOTg3OWUwYWZjZjRhZjQ3NXAyMjI3MjI@fresh-sculpin-22722.upstash.io:6379' }}
 
        steps:
            # Detect if GH "Enable debug logging" is ON
            - name: üîé Detect GH debug flag
              id: detect_debug
              shell: bash
              run: |
                  # ACTIONS_STEP_DEBUG is set to 'true' when GH debug logging is enabled
                  echo "gh_debug=${ACTIONS_STEP_DEBUG:-false}" >> "$GITHUB_OUTPUT"

            - name: üõéÔ∏è Checkout
              uses: actions/checkout@v5

            - name: üß∞ Install PowerShell
              uses: ./.github/actions/Install-PowerShell
              with:
                  Version: ${{ matrix.pwsh }}

            - name: üß∞ Setup .NET 8/9
              uses: actions/setup-dotnet@v5
              with:
                  dotnet-version: |
                      8.0.x
                      9.0.x

            # üîä Only enable super-verbose logs in debug runs
            - name: üîß Enable debug flags
              if: ${{ steps.detect_debug.outputs.enabled == 'true' }}
              shell: bash
              run: |
                  {
                    echo "ACTIONS_STEP_DEBUG=true"
                    echo "ACTIONS_RUNNER_DEBUG=true"
                    echo "COREHOST_TRACE=1"
                    echo "COREHOST_TRACE_VERBOSITY=3"
                    echo "DOTNET_HOST_TRACE=1"
                    echo "DOTNET_HOST_TRACE_VERBOSITY=3"
                  } >> "$GITHUB_ENV"

            - name: üîß Echo debug flag
              run: echo "debug=${{ steps.detect_debug.outputs.enabled }}  event=${{ github.event_name }}"
              if: ${{ always() && github.event_name != '' }}

            # üîä decide verbosity once, early
            - name: üîß Set build verbosity
              shell: bash
              run: |
                  if [[ "${{ steps.detect_debug.outputs.enabled == 'true' }}" == "true" ]]; then
                    echo "DOTNET_VERBOSITY=diag" >> "$GITHUB_ENV"
                    echo "PESTER_VERBOSITY=Detailed" >> "$GITHUB_ENV"
                  else
                    echo "DOTNET_VERBOSITY=minimal" >> "$GITHUB_ENV"
                    echo "PESTER_VERBOSITY=Normal" >> "$GITHUB_ENV"
                  fi

            - name: üß∞ Install Module Invoke-Build
              shell: pwsh
              run: |
                  $ErrorActionPreference = 'Stop'
                  Install-Module InvokeBuild -Force -Scope CurrentUser

            - name: üß∞ Install Module Pester (pin)
              shell: pwsh
              run: |
                  $ErrorActionPreference = 'Stop'
                  Install-Module Pester -Force -Scope CurrentUser -RequiredVersion 5.6.1
                  Get-Module Pester -ListAvailable | Select Name,Version,Path

            - name: üîé Print runtime context
              shell: pwsh
              run: |
                  $PSVersionTable
                  dotnet --info
                  [System.Runtime.InteropServices.RuntimeInformation]::FrameworkDescription
                  [System.Environment]::Version

            - name: üîç Debug environment variables
              shell: pwsh
              run: |
                  Write-Host "üîç [DEBUG] Checking UPSTASH_REDIS_URL availability..."
                  $upstashValue = [System.Environment]::GetEnvironmentVariable('UPSTASH_REDIS_URL')
                  if ($upstashValue) {
                      if ([string]::IsNullOrWhiteSpace($upstashValue)) {
                          Write-Host "‚ö†Ô∏è UPSTASH_REDIS_URL is set but empty/whitespace (length: $($upstashValue.Length))" -ForegroundColor Yellow
                          Write-Host "‚ö†Ô∏è Value: '$upstashValue'" -ForegroundColor Yellow
                      } else {
                          Write-Host "‚úÖ UPSTASH_REDIS_URL is set (length: $($upstashValue.Length))" -ForegroundColor Green
                          Write-Host "‚úÖ UPSTASH_REDIS_URL starts with: $($upstashValue.Substring(0, [Math]::Min(20, $upstashValue.Length)))..." -ForegroundColor Green
                      }
                  } else {
                      Write-Host "‚ùå UPSTASH_REDIS_URL is NOT set" -ForegroundColor Red
                  }
                  Write-Host "üîç All environment variables containing UPSTASH:"
                  Get-ChildItem env: | Where-Object Name -like "*UPSTASH*" | ForEach-Object { 
                      $value = $_.Value
                      if ([string]::IsNullOrWhiteSpace($value)) {
                          Write-Host "  $($_.Name) = [EMPTY/WHITESPACE] (length: $($value.Length))" -ForegroundColor Red
                      } else {
                          Write-Host "  $($_.Name) = $($value.Substring(0, [Math]::Min(20, $value.Length)))... (length: $($value.Length))" -ForegroundColor Yellow 
                      }
                  }
                  
                  # Also check what GitHub is actually passing
                  Write-Host "üîç GitHub Actions context debug:"
                  Write-Host "  secrets.UPSTASH_REDIS_URL exists: ${{ secrets.UPSTASH_REDIS_URL != '' }}"
                  Write-Host "  Fallback would be: redis://default:test@localhost:6379"

            - name: üì¶ Restore solution
              shell: pwsh
              run: Invoke-Build Restore -DotNetVerbosity $Env:DOTNET_VERBOSITY

            # üêõ Debug-only; non-fatal if it exits 1
            - name: üîé List Roslyn packages (transitive)
              if: ${{ steps.detect_debug.outputs.enabled == 'true' }}
              continue-on-error: true
              shell: pwsh
              run: |
                  dotnet list ./Kestrun.sln package --include-transitive -v $Env:DOTNET_VERBOSITY |
                    Select-String -SimpleMatch "Microsoft.CodeAnalysis"
                  Write-Host "Exit code was $LASTEXITCODE (ignored in debug)"

            # üêõ Debug-only; non-fatal inventory
            - name: üìÇ List Roslyn candidates in repo
              if: ${{ steps.detect_debug.outputs.enabled == 'true' }}
              continue-on-error: true
              shell: pwsh
              run: |
                  Get-ChildItem -Recurse -File -Include Microsoft.CodeAnalysis*.dll,System.Collections.Immutable*.dll,System.Reflection.Metadata*.dll |
                    Sort-Object FullName |
                    Select-Object FullName, Length |
                    Format-Table -Auto

            - name: üîß Run C# Build (normal)
              shell: pwsh
              run: |
                  $ErrorActionPreference = 'Stop'
                  Invoke-Build Build -DotNetVerbosity $Env:DOTNET_VERBOSITY

            # üêõ Optional deep-dive build with binlog in debug (non-fatal)
            - name: üß∞ Debug build with binlog
              if: ${{ steps.detect_debug.outputs.enabled == 'true' }}
              continue-on-error: true
              shell: pwsh
              run: |
                  dotnet build ./Kestrun.sln -c Debug -bl:msbuild.binlog -v $Env:DOTNET_VERBOSITY || $true

            # üêõ Debug-only; force Roslyn load (non-fatal)
            - name: üß™ Mini Roslyn sanity check (before Pester)
              if: ${{ steps.detect_debug.outputs.enabled == 'true' }}
              continue-on-error: true
              shell: pwsh
              run: |
                  $ErrorActionPreference = 'Continue'
                  Import-Module ./src/PowerShell/Kestrun/Kestrun.psd1 -Force
                  [AppDomain]::CurrentDomain.GetAssemblies() |
                    Where-Object { $_.GetName().Name -like 'Microsoft.CodeAnalysis*' -or $_.GetName().Name -in 'System.Collections.Immutable','System.Reflection.Metadata' } |
                    Select FullName, Location | Format-Table -Auto

                  if ([type]::GetType('Kestrun.Scripting.CSharpDelegateBuilder')) {
                    try { [Kestrun.Scripting.CSharpDelegateBuilder]::Compile('int x=1;') } catch { $_ | Out-String | Write-Host }
                  }

            - name: üß™ Run Tests
              shell: pwsh
              run: |
                  $ErrorActionPreference = 'Stop'
                  Invoke-Build Test -DotNetVerbosity $Env:DOTNET_VERBOSITY -PesterVerbosity $Env:PESTER_VERBOSITY -RunPesterInProcess

            - name: üì§ Upload diagnostics on failure
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: diagnostics-${{ matrix.os }}-pwsh-${{ matrix.pwsh }}-${{ strategy.job-index }}
                  path: |
                      **/TestResults/**
                      **/bin/**
                      **/obj/project.assets.json
                      src/PowerShell/Kestrun/**/*
                      ./*.log
                      ./msbuild.binlog

            # üîê Only open an interactive shell when YOU asked for debug and it failed
            - name: üßë‚Äçüíª Live SSH (only if failed and debug enabled)
              if: ${{ failure() && steps.detect_debug.outputs.gh_debug == 'true' }}
              uses: mxschmitt/action-tmate@v3
              with:
                  limit-access-to-actor: true
