---
layout: default
parent: PowerShell Tutorials
title: Product Search with HTTP QUERY (OpenAPI 3.2)
nav_order: 19
---

# Product Search with HTTP QUERY (OpenAPI 3.2)

Demonstrates the OpenAPI 3.2 HTTP `QUERY` method with structured request body filters, pagination parameters, and response content negotiation.

## Full source

File: [`pwsh/tutorial/examples/10.19-OpenAPI-Hello-Query.ps1`][10.19-OpenAPI-Hello-Query.ps1]

```powershell
{% include examples/pwsh/10.19-OpenAPI-Hello-Query.ps1 %}
```

## Step-by-step

1. **Server Setup**: Create the host with [New-KrServer][New-KrServer] and configure an endpoint with [Add-KrEndpoint][Add-KrEndpoint].

2. **OpenAPI Metadata**: Register OpenAPI info with [Add-KrOpenApiInfo][Add-KrOpenApiInfo] specifying the API title, version, and description.

3. **Parameter Components**: Define reusable pagination parameters using `[OpenApiParameterComponent]` attribute with validation constraints (e.g., `ValidateRange`).

4. **Schema Components**: Define request and response schemas as PowerShell classes:

    - `Product`: Represents items with id, name, price, and stock properties.
    - `ProductSearchRequest`: Captures filters like `q` (query), `category`, `minPrice`, `maxPrice`, and `inStock`.

5. **Route Function with QUERY**: Create a function decorated with
   `[OpenApiPath(HttpVerb = 'query', Pattern = '/v1/products/search')]` to define the HTTP QUERY
   operation.

6. **Parameter References**: Use `[OpenApiParameterRef]` to reference reusable pagination components in the route parameters.

7. **Request Body**: Accept filters via `[OpenApiRequestBody]` parameter decorated with the
   `ProductSearchRequest` schema.

8. **Filtering Logic**: Inside the route, filter the product collection based on the request
   criteria (text search, category, price range, stock availability).

9. **Pagination**: Calculate offset/limit using page and pageSize, then return a slice of results.

10. **Negotiated Response**: Use [Write-KrResponse][Write-KrResponse] (not `Write-KrJsonResponse`) to enable content negotiation based on the `Accept` header
    (JSON, YAML, XML).

11. **Configuration**: Call [Enable-KrConfiguration][Enable-KrConfiguration] to commit all staged changes and inject helper functions into route runspaces.

12. **Documentation Routes**: Register UI viewers with [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute] (Swagger, ReDoc, RapiDoc, Scalar, Elements).

13. **OpenAPI Route**: Register the OpenAPI document endpoint with [Add-KrOpenApiRoute][Add-KrOpenApiRoute],
    specifying `DefaultVersion '3.2'` for modern OpenAPI support.

14. **Start Server**: Call [Start-KrServer][Start-KrServer] to begin accepting requests.

## Try it

Save the sample and run:

```powershell
# From repository root
Import-Module .\src\PowerShell\Kestrun\Kestrun.psd1 -Force
.\docs\_includes\examples\pwsh\10.19-OpenAPI-Hello-Query.ps1 -Port 5000
```

Then open [**http://127.0.0.1:5000/docs/swagger**](http://127.0.0.1:5000/docs/swagger) in your browser to
view the interactive API documentation.

### Test the QUERY endpoint

Using curl:

```powershell
curl -X QUERY "http://127.0.0.1:5000/v1/products/search?page=1&pageSize=2" `
  -H "Content-Type: application/json" `
  -H "Accept: application/json" `
  -d "{""q"":""lap"",""category"":""electronics"",""minPrice"":800,""inStock"":true}"
```

Using PowerShell:

```powershell
$body = @{
    q = 'lap'
    category = 'electronics'
    minPrice = 800
    inStock = $true
} | ConvertTo-Json -Depth 5

$result = Invoke-WebRequest -Uri 'http://127.0.0.1:5000/v1/products/search?page=1&pageSize=2' `
    -CustomMethod 'QUERY' `
    -ContentType 'application/json' `
    -Body $body `
    -Headers @{ Accept = 'application/json' } `
    -SkipCertificateCheck

$result.Content | ConvertFrom-Json | Format-Table
```

Stop the server with Ctrl+C.

## Troubleshooting

-   **Port already in use**: Choose a different port with `-Port 5001` or similar.
-   **QUERY not recognized**: Ensure PowerShell 7.4+ (which supports `-CustomMethod 'QUERY'` in `Invoke-WebRequest`).
-   **OpenAPI spec mismatch**: Verify `HttpVerb = 'query'` in the function's `[OpenApiPath]` attribute; OpenAPI 3.2 uses `query` (lowercase) as the operation key.
-   **No documentation UIs**: Check that [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute] is called _before_ [Enable-KrConfiguration][Enable-KrConfiguration].
-   **Negotiated response returns JSON only**: Ensure you use [Write-KrResponse][Write-KrResponse]
    (not `Write-KrJsonResponse`); the latter forces JSON regardless of `Accept` header.

## References

-   [New-KrServer][New-KrServer]
-   [Add-KrEndpoint][Add-KrEndpoint]
-   [Add-KrOpenApiInfo][Add-KrOpenApiInfo]
-   [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]
-   [Add-KrOpenApiRoute][Add-KrOpenApiRoute]
-   [Enable-KrConfiguration][Enable-KrConfiguration]
-   [Write-KrResponse][Write-KrResponse]
-   [Start-KrServer][Start-KrServer]
-   [OpenAPI-Guide][OpenAPI-Guide]

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Multiple OpenAPI Documents](./18.Multi-Document-OpenAPI.md)
Next: _None_

[10.19-OpenAPI-Hello-Query.ps1]: /pwsh/tutorial/examples/10.19-OpenAPI-Hello-Query.ps1
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Add-KrOpenApiInfo]: /pwsh/cmdlets/Add-KrOpenApiInfo
[Add-KrApiDocumentationRoute]: /pwsh/cmdlets/Add-KrApiDocumentationRoute
[Add-KrOpenApiRoute]: /pwsh/cmdlets/Add-KrOpenApiRoute
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrResponse]: /pwsh/cmdlets/Write-KrResponse
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[OpenAPI-Guide]: /guides/openapi
