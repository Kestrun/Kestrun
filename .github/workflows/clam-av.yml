permissions:
  contents: read

name: AV scan (ClamAV)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  clamav:
    runs-on: ubuntu-24.04
    steps:
      - name: 🛎️ Checkout
        uses: actions/checkout@v5
       
      - name: 🧰 Install PowerShell
        uses: ./.github/actions/Install-PowerShell
        with:
          Version: 'latest'

      - name: 🧰 Setup .NET 8
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: 🧰 Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: 🧰 Install Module Invoke-Build
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Install-Module InvokeBuild -Force -Scope CurrentUser

      - name: 🔎 Print runtime context
        shell: pwsh
        run: |
          $PSVersionTable
          dotnet --info
          [System.Runtime.InteropServices.RuntimeInformation]::FrameworkDescription
          [System.Environment]::Version

      - name: 📦 Restore solution
        shell: pwsh
        run: Invoke-Build Restore

      - name: 🔧 Run C# Build (normal)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-Build Build -Configuration 'Release'

      # --- ClamAV section (full-repo scan) ---
      - name: 🧰 Install ClamAV
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y clamav clamav-daemon

      - name: 🧼 Update ClamAV signatures
        shell: bash
        run: |
          set -euo pipefail
          sudo systemctl stop clamav-freshclam || true
          # Avoid file-lock logging noise in CI
          sudo sed -i 's/^UpdateLogFile .*/# disabled in CI/' /etc/clamav/freshclam.conf || true
          sudo freshclam --stdout

      - name: 🛡️ Scan full repo recursively
        shell: bash
        run: |
          set -euo pipefail
          # clamscan exit codes: 0=clean, 1=infected, 2=error
          # Exclude the .git folder to speed things up a touch (optional).
          clamscan -r . --infected --no-summary --exclude-dir="^\.\/\.git$" | tee clamscan.raw.log
          inf=$(grep -c 'FOUND$' clamscan.raw.log || true)
          {
            echo "----------- SCAN SUMMARY -----------"
            echo "Infected files: $inf"
          } | tee clamscan.summary.log
          cat clamscan.summary.log >> clamscan.raw.log
          mv clamscan.raw.log clamscan.log

      - name: ⛔ Fail if infected
        shell: bash
        run: |
          ! grep -q "Infected files: [^0]" clamscan.log

      - name: 📎 Upload scan log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: clamscan-log
          path: clamscan.log
