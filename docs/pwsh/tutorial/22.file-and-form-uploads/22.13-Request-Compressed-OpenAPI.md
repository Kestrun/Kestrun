---
layout: default
parent: File and Form Uploads
title: OpenAPI: request-level compression
nav_order: 13
---

# OpenAPI: request-level compression

Document request-compressed multipart uploads with OpenAPI.

## Full source

File: [`pwsh/tutorial/examples/22.13-Request-Compressed-OpenAPI.ps1`][22.13-Request-Compressed-OpenAPI.ps1]

```powershell
{% include examples/pwsh/22.13-Request-Compressed-OpenAPI.ps1 %}
```

## Step-by-step

1. Logger: Register a console logger for visibility.
2. Server: Create the host and bind a listener.
3. OpenAPI: Add document info and contact metadata.
4. Middleware: Enable request decompression for gzip.
5. Storage: Set the default upload directory.
6. Model: Define `RequestCompressedUpload` with `KrBindForm` and `KrPart`.
7. Route: Declare `/upload` with `[OpenApiPath]` and `[OpenApiRequestBody]`.
8. Docs: Register the OpenAPI route and documentation UIs, then start the server.

## Try it

```powershell
$boundary = 'req-boundary'
$body = @(
    "--$boundary",
    'Content-Disposition: form-data; name=note',
    '',
    'compressed',
    "--$boundary",
    'Content-Disposition: form-data; name=file; filename=hello.txt',
    'Content-Type: text/plain',
    '',
    'hello',
    "--$boundary--",
    ''
) -join "`r`n"
$bytes = [System.Text.Encoding]::UTF8.GetBytes($body)
$ms = [System.IO.MemoryStream]::new()
$gzip = [System.IO.Compression.GZipStream]::new($ms, [System.IO.Compression.CompressionMode]::Compress, $true)
$gzip.Write($bytes, 0, $bytes.Length)
$gzip.Dispose()
$compressed = $ms.ToArray()
Invoke-WebRequest -Method Post -Uri 'http://127.0.0.1:5000/upload' -ContentType "multipart/form-data; boundary=$boundary" -Headers @{ 'Content-Encoding'='gzip' } -Body $compressed
```

## Troubleshooting

- 415 / Unsupported Content-Encoding: Ensure request decompression is enabled for `gzip`.
- 400 / Bad Request: Confirm the body is a real byte array after compression.

## References

- [Add-KrRequestDecompressionMiddleware][Add-KrRequestDecompressionMiddleware]
- [Add-KrOpenApiInfo][Add-KrOpenApiInfo]
- [Add-KrOpenApiContact][Add-KrOpenApiContact]
- [Add-KrOpenApiRoute][Add-KrOpenApiRoute]
- [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]
- [Set-KrServerOptions][Set-KrServerOptions]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Write-KrJsonResponse][Write-KrJsonResponse]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [OpenAPI: nested multipart](./22.12-Nested-Multipart-OpenAPI)
Next: [OpenAPI: part-level compression](./22.14-Part-Compressed-OpenAPI)

[22.13-Request-Compressed-OpenAPI.ps1]: /pwsh/tutorial/examples/22.13-Request-Compressed-OpenAPI.ps1
[Add-KrRequestDecompressionMiddleware]: /pwsh/cmdlets/Add-KrRequestDecompressionMiddleware
[Add-KrOpenApiInfo]: /pwsh/cmdlets/Add-KrOpenApiInfo
[Add-KrOpenApiContact]: /pwsh/cmdlets/Add-KrOpenApiContact
[Add-KrOpenApiRoute]: /pwsh/cmdlets/Add-KrOpenApiRoute
[Add-KrApiDocumentationRoute]: /pwsh/cmdlets/Add-KrApiDocumentationRoute
[Set-KrServerOptions]: /pwsh/cmdlets/Set-KrServerOptions
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
