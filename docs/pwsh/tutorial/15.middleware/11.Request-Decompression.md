---
title: Request Decompression
parent: Middleware
nav_order: 11
layout: default
---

# Request Decompression

Accept request bodies compressed with `Content-Encoding` (for example `gzip`) by enabling the Request Decompression middleware.

This is **request-level** decompression: the client compresses the **entire HTTP request body**,
and middleware decompresses it before Kestrun reads/parses the body.

## Full source

File: [`pwsh/tutorial/examples/15.11-Request-Decompression.ps1`][15.11-Request-Decompression.ps1]

```powershell
{% include examples/pwsh/15.11-Request-Decompression.ps1 %}
```

## Step-by-step

1. Logging: Register a console logger for visibility.
2. Server: Create a server and listener (IP + port).
3. Middleware: Add `Add-KrRequestDecompressionMiddleware -AllowedEncoding gzip`.
4. Configuration: Call `Enable-KrConfiguration` so middleware/routes are active.
5. Echo route: Implement `POST /api/echo` that reads the decompressed body via `Get-KrRequestBody -Raw`.
6. Run: Start the server and send a gzipped JSON request body.

## Try it

Start the server:

```powershell
pwsh .\docs\_includes\examples\pwsh\15.11-Request-Decompression.ps1
```

Verify the server is up:

```powershell
curl -i http://127.0.0.1:5000/
```

Send a request-compressed JSON body (PowerShell 7+):

```powershell
$payloadObject = @{
  message = (('hello ' * 20000).Trim())
  count   = 1
  items   = 1..2000
  meta    = @{ note = ('x' * 20000) }
}
$payload = $payloadObject | ConvertTo-Json -Compress -Depth 6
$bytes = [System.Text.Encoding]::UTF8.GetBytes($payload)

$ms = [System.IO.MemoryStream]::new()
$gzip = [System.IO.Compression.GZipStream]::new($ms, [System.IO.Compression.CompressionMode]::Compress, $true)
$gzip.Write($bytes, 0, $bytes.Length)
$gzip.Dispose()

Invoke-RestMethod -Method Post -Uri 'http://127.0.0.1:5000/api/echo' \
  -ContentType 'application/json' \
  -Headers @{ 'Content-Encoding' = 'gzip' } \
  -Body $ms.ToArray()
```

Expected output:

```json
{"ok":true,"receivedBytes":123456,"receivedCount":1,"messageStartsWith":"hello"}
```

## Key points

- **Response compression** uses `Accept-Encoding` (client asks), and the server replies with `Content-Encoding`.
- **Request decompression** uses `Content-Encoding` (client sends), and `Get-KrRequestBody -Raw` returns the decompressed body.
- `-AllowedEncoding` should be set to the encodings you want to accept (commonly `gzip`).

## Troubleshooting

| Symptom | Cause | Fix |
|--------|-------|-----|
| 415 / 400 when sending gzip body | Middleware missing or not configured | Ensure `Add-KrRequestDecompressionMiddleware -AllowedEncoding gzip` is present before `Enable-KrConfiguration`. |
| 400 JSON parsing error | Body not valid JSON after decompression | Confirm you send `-ContentType 'application/json'` and gzip a valid JSON payload. |
| Server accepts uncompressed but not compressed | Missing `Content-Encoding` header | Include `-Headers @{ 'Content-Encoding'='gzip' }`. |

## References

- [Add-KrRequestDecompressionMiddleware][Add-KrRequestDecompressionMiddleware]
- [Get-KrRequestBody][Get-KrRequestBody]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Start-KrServer][Start-KrServer]
- [Compression guide][Compression-Guide]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [SSE Broadcast](./10.SseBroadcast)
Next: [Health](../16.health/index)

[15.11-Request-Decompression.ps1]: /pwsh/tutorial/examples/15.11-Request-Decompression.ps1
[Add-KrRequestDecompressionMiddleware]: /pwsh/cmdlets/Add-KrRequestDecompressionMiddleware
[Get-KrRequestBody]: /pwsh/cmdlets/Get-KrRequestBody
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Start-KrServer]: /pwsh/cmdlets/Start-KrServer
[Compression-Guide]: /guides/compression
