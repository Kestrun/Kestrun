permissions:
  contents: read
name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: {}

concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  coverage:
    runs-on: ubuntu-24.04
    env:
      POWERSHELL_DISTRIBUTION_CHANNEL: GitHub-Actions
      DOTNET_VERBOSITY: minimal
      PESTER_VERBOSITY: Normal

    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v5

      - name: üß∞ Setup .NET 8 & 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json

      - name: üß∞ Install PowerShell
        uses: ./.github/actions/Install-PowerShell
        with:
          Version: latest

      # Non-interactive PSResource install (trust PSGallery)
      - name: üß∞ Install Invoke-Build & Pester (trusted, non-interactive)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Scope CurrentUser -Force -SkipPublisherCheck -AllowClobber
          }
          Import-Module Microsoft.PowerShell.PSResourceGet -Force
          $repo = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $repo) {
            Register-PSResourceRepository -Name PSGallery -Uri 'https://www.powershellgallery.com/api/v3/index.json' -Trusted
          } elseif (-not $repo.Trusted) {
            Set-PSResourceRepository -Name PSGallery -Trusted
          }
          Install-PSResource -Repository PSGallery -TrustRepository -Scope CurrentUser -Name 'InvokeBuild','Pester'
          Get-Module Pester -ListAvailable | Select Name,Version,Path

      - name: üì¶ Restore
        shell: pwsh
        run: Invoke-Build Restore -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üîß Build
        shell: pwsh
        run: Invoke-Build Build -DotNetVerbosity $Env:DOTNET_VERBOSITY

      # --- .NET coverage via built-in XPlat collector (no coverlet.msbuild needed) ---
      - name: üß™ .NET tests net8.0 (XPlat -> Cobertura)
        run: |
          dotnet test tests/CSharp.Tests/Kestrun.Tests/KestrunTests.csproj \
            --no-build \
            -f net8.0 \
            --collect "XPlat Code Coverage" \
            -v $DOTNET_VERBOSITY

      - name: üß™ .NET tests net9.0 (XPlat -> Cobertura)
        run: |
          dotnet test tests/CSharp.Tests/Kestrun.Tests/KestrunTests.csproj \
            --no-build \
            -f net9.0 \
            --collect "XPlat Code Coverage" \
            -v $DOTNET_VERBOSITY

      # --- PowerShell coverage (Pester 5 config -> JaCoCo) ---
      - name: üß™ PowerShell tests with coverage (Pester 5)
        shell: pwsh
        run: |
          $cfg = New-PesterConfiguration
          $cfg.Run.Path = @('tests/PowerShell.Tests')
          $cfg.Run.Exit = $true
          $cfg.Output.Verbosity = $Env:PESTER_VERBOSITY
          $cfg.CodeCoverage.Enabled = $true
          $cfg.CodeCoverage.Path = @('src/PowerShell/Kestrun/*.psm1','src/PowerShell/Kestrun/*.ps1')
          $cfg.CodeCoverage.OutputFormat = 'JaCoCo'
          $cfg.CodeCoverage.OutputPath = 'TestResults/pester-coverage.xml'
          Invoke-Pester -Configuration $cfg

      # --- Sanity: show what coverage files were produced ---
      - name: üîé List raw coverage files
        run: |
          echo "Cobertura files:"
          find . -name "coverage.cobertura.xml" -print || true
          echo "Pester JaCoCo file:"
          ls -la TestResults/pester-coverage.xml || true

      # --- Merge to LCOV ---
      - name: üßÆ Merge coverage to LCOV
        run: |
          dotnet tool install -g dotnet-reportgenerator-globaltool
          reportgenerator \
            -reports:"**/coverage.cobertura.xml;TestResults/pester-coverage.xml" \
            -targetdir:"coveragereport" \
            -reporttypes:lcov \
            -sourcedirs:"src/PowerShell/Kestrun;src/CSharp/Kestrun;."

      # --- Inspect LCOV (debug) ---
      - name: üîé Inspect LCOV
        run: |
          echo "lcov size:"
          wc -l coveragereport/lcov.info || true
          echo "first 60 lines:"
          head -n 60 coveragereport/lcov.info || true
          echo "count of SF/DA:"
          grep -E '^(SF|DA):' -n coveragereport/lcov.info || true

      # --- Upload to Coveralls ---
      - name: ‚òÅÔ∏è Upload to Coveralls
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: coveragereport/lcov.info
          format: lcov
          base-path: ${{ github.workspace }}
          allow-empty: true
          debug: true

      # Keep the report as an artifact for quick inspection
      - name: üì¶ Upload LCOV artifact
        uses: actions/upload-artifact@v4
        with:
          name: lcov
          path: coveragereport/lcov.info
