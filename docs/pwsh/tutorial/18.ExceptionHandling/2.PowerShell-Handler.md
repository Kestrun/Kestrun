---
title: PowerShell Handler
parent: Exception Handling
nav_order: 2
---

# PowerShell Handler

Handle exceptions within PowerShell route scripts and use middleware for non-PowerShell endpoints.

## Full source

File: [`pwsh/tutorial/examples/18.2-ExceptionHandling-PowerShell.ps1`][18.2-ExceptionHandling-PowerShell.ps1]

```powershell
{% include examples/pwsh/18.2-ExceptionHandling-PowerShell.ps1 %}
```

## Step-by-step

1. Logging: Register console logger as default.
2. Server: Create server and listen on loopback.
3. Middleware: Register `Enable-KrExceptionHandling -ScriptBlock` for non-PowerShell endpoints.
4. Routes: Map `/ok`, `/oops` (PowerShell throw), and `/csharp-error` (C# inline throw).
5. Response: Allow PowerShell routes to throw (handled by script) and C# to be handled by middleware.
6. Start: Apply configuration and start the server.

## Try it

```powershell
# OK
curl -i http://127.0.0.1:5000/ok

# PowerShell exception (script throws)
curl -i http://127.0.0.1:5000/oops

# C# exception (handled by middleware)
curl -i http://127.0.0.1:5000/csharp-error
```

PowerShell equivalents:

```powershell
Invoke-WebRequest -Uri http://127.0.0.1:5000/ok -UseBasicParsing | Select-Object StatusCode, Content
Invoke-WebRequest -Uri http://127.0.0.1:5000/oops -UseBasicParsing -SkipHttpErrorCheck | Select-Object StatusCode, Content
Invoke-WebRequest -Uri http://127.0.0.1:5000/csharp-error -UseBasicParsing -SkipHttpErrorCheck | Select-Object StatusCode, Content
```

## Troubleshooting

- PowerShell exceptions not handled by middleware? Ensure you're using `-ScriptBlock` for
  non-PS endpoints and that PS routes either catch/format or allow exceptions to bubble
  as desired.
- C# endpoint returning HTML instead of JSON? Confirm your handler writes JSON and sets the content type.

## References

- [Enable-KrExceptionHandling][Enable-KrExceptionHandling]
- [Add-KrMapRoute][Add-KrMapRoute]
- [Write-KrJsonResponse][Write-KrJsonResponse]
- [Write-KrTextResponse][Write-KrTextResponse]

---

### Previous / Next

Previous: [Re-execute to Path](./1.ExceptionHandlingPath.md)
Next: [C# Inline Handler](./3.CSharp-Inline.md)

[18.2-ExceptionHandling-PowerShell.ps1]: /pwsh/tutorial/examples/18.2-ExceptionHandling-PowerShell.ps1
[Enable-KrExceptionHandling]: /pwsh/cmdlets/Enable-KrExceptionHandling
[Add-KrMapRoute]: /pwsh/cmdlets/Add-KrMapRoute
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
[Write-KrTextResponse]: /pwsh/cmdlets/Write-KrTextResponse
