---
layout: default
parent: File and Form Uploads
title: Nested multipart/mixed
nav_order: 5
---

# Nested multipart/mixed

Handle a single nested multipart/mixed payload inside an ordered multipart body.

## Full source

File: [`pwsh/tutorial/examples/22-file-and-form-uploads/22.5-nested-multipart.ps1`][22.5-nested-multipart.ps1]

```powershell
{% include examples/pwsh/22.5-nested-multipart.ps1 %}
```

## Step-by-step

1. Logger: Enable console logging.
2. Server: Create the host and bind a listener.
3. Options: Opt in to `multipart/mixed` and allow one level of nested multipart content.
4. Route: Add `/nested` with `Add-KrFormRoute`.
5. Response: Summarize outer parts and nested counts.

## Try it

```powershell
$outer = 'outer-boundary'
$inner = 'inner-boundary'
$innerBody = @(
    "--$inner",
  "Content-Disposition: form-data; name=\"text\"",
    "Content-Type: text/plain",
    "",
    "inner-1",
    "--$inner",
  "Content-Disposition: form-data; name=\"json\"",
    "Content-Type: application/json",
    "",
    '{"nested":true}',
    "--$inner--",
    ""
) -join "`r`n"
$outerBody = @(
    "--$outer",
  "Content-Disposition: form-data; name=\"outer\"",
    "Content-Type: application/json",
    "",
    '{"stage":"outer"}',
    "--$outer",
  "Content-Disposition: form-data; name=\"nested\"",
    "Content-Type: multipart/mixed; boundary=$inner",
    "",
    $innerBody,
    "--$outer--",
    ""
) -join "`r`n"
Invoke-RestMethod -Method Post -Uri 'http://127.0.0.1:5000/nested' -ContentType "multipart/mixed; boundary=$outer" -Body $outerBody
```

```bash
cat > payload.txt <<'EOF'
--outer-boundary
Content-Disposition: form-data; name="outer"
Content-Type: application/json

{"stage":"outer"}
--outer-boundary
Content-Disposition: form-data; name="nested"
Content-Type: multipart/mixed; boundary=inner-boundary

--inner-boundary
Content-Disposition: form-data; name="text"
Content-Type: text/plain

inner-1
--inner-boundary
Content-Disposition: form-data; name="json"
Content-Type: application/json

{"nested":true}
--inner-boundary--
--outer-boundary--
EOF

curl -X POST -H "Content-Type: multipart/mixed; boundary=outer-boundary" --data-binary @payload.txt http://127.0.0.1:5000/nested
```

## Expected output

```json
{
  "outerCount": 2,
  "nested": [
    { "outerContentType": "multipart/mixed", "nestedCount": 2 }
  ]
}
```

## Notes

- Content types: `Add-KrFormRoute` defaults to `multipart/form-data` only; this script opts in to `multipart/mixed`.
- Limits: `MaxNestingDepth` defaults to 1; increase with care.
- Security: Nested multipart parts are stored to disk before parsing.
- Logging: Nested parsing decisions are logged via `host.Logger`.
- Rules: If you configure `KrPartRule`, include `Content-Disposition: ...; name="..."` in outer and nested parts.

## Troubleshooting

- 415 / Unsupported Content-Type: Ensure the outer request `Content-Type` is `multipart/mixed; boundary=...` and the route options allow it.
- Nested parts not detected: Ensure the nested part has `Content-Type: multipart/mixed; boundary=...` and includes its own boundary markers.

## References

- [Add-KrFormRoute][Add-KrFormRoute]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Write-KrJsonResponse][Write-KrJsonResponse]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [multipart/mixed ordered parts](./22.4-Multipart-Mixed)
Next: [Request-level compression](./22.6-Request-Compressed)

[22.5-nested-multipart.ps1]: /pwsh/tutorial/examples/22-file-and-form-uploads/22.5-nested-multipart.ps1
[Add-KrFormRoute]: /pwsh/cmdlets/Add-KrFormRoute
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
