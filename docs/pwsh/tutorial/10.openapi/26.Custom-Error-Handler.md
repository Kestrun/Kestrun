---
title: Custom Error Handler
parent: OpenApi
nav_order: 26
layout: default
---

# Custom Error Handler

Use OpenAPI error schemas with a custom PowerShell runtime error response script for OpenAPI routes.

## Full source

File: [`pwsh/tutorial/examples/10.26-OpenAPI-Custom-Error-Handler.ps1`][10.26-OpenAPI-Custom-Error-Handler.ps1]

```powershell
{% include examples/pwsh/10.26-OpenAPI-Custom-Error-Handler.ps1 %}
```

## Step-by-step

1. **Server and logger**: Create the server, endpoint, and console logger.
2. **OpenAPI metadata**: Add OpenAPI info and set the error schema contract with `Set-KrOpenApiErrorSchema`.
3. **Custom runtime handler**: Register `Set-KrPowerShellErrorResponse` with a scriptblock that builds a consistent ProblemDetails-style payload.
4. **Schema components**: Define `OrderDto`, `CreateOrderRequest`, and `ApiError` as reusable OpenAPI components.
5. **GET route**: Add `/orders/{orderId}` with OpenAPI responses and throw for a specific ID to trigger the custom error path.
6. **POST route**: Add `/orders` with JSON request body and OpenAPI 415/500 error responses.
7. **OpenAPI routes**: Expose `/openapi/*` and Swagger docs, then build and validate the document.
8. **Run**: Start the server and verify both success and error behavior.

## Try it

```powershell
# Success path
curl -i http://127.0.0.1:5000/orders/1

# Runtime exception path (custom 500 payload)
curl -i http://127.0.0.1:5000/orders/13

# Media type contract error (custom 415 payload)
curl -i -X POST http://127.0.0.1:5000/orders \
  -H "Content-Type: text/plain" \
  -d "bad"

# OpenAPI document
curl -i http://127.0.0.1:5000/openapi/v3.1/openapi.json
```

PowerShell equivalent for POST:

```powershell
Invoke-WebRequest -Uri http://127.0.0.1:5000/orders `
    -Method Post `
    -ContentType 'text/plain' `
    -Body 'bad' `
    -SkipHttpErrorCheck | Select-Object StatusCode, Content
```

## Key points

- `Set-KrOpenApiErrorSchema` controls the OpenAPI contract for generated/standardized error responses.
- `Set-KrPowerShellErrorResponse` controls runtime payload shape when PowerShell route execution hits an error path.
- This pattern is OpenAPI-focused: your route docs and runtime errors stay aligned around a shared `ApiError` schema.

## Troubleshooting

- **415 does not return JSON**: send `Accept: application/json` in your request while validating payload shape.
- **Custom payload not applied**: ensure `Set-KrPowerShellErrorResponse` runs before `Start-KrServer` and the scriptblock does not throw.
- **OpenAPI missing error schema**: verify `Set-KrOpenApiErrorSchema` is configured before `Build-KrOpenApiDocument`.

## References

- [Add-KrOpenApiInfo][Add-KrOpenApiInfo]
- [Set-KrOpenApiErrorSchema][Set-KrOpenApiErrorSchema]
- [Set-KrPowerShellErrorResponse][Set-KrPowerShellErrorResponse]
- [OpenApiPath][OpenApiPath]
- [OpenApiRequestBody][OpenApiRequestBody]
- [OpenApiResponse][OpenApiResponse]
- [OpenApiSchemaComponent][OpenApiSchemaComponent]
- [Add-KrOpenApiRoute][Add-KrOpenApiRoute]
- [Build-KrOpenApiDocument][Build-KrOpenApiDocument]
- [Test-KrOpenApiDocument][Test-KrOpenApiDocument]
- [Add-KrApiDocumentationRoute][Add-KrApiDocumentationRoute]
- [OpenAPI Runtime Error Payload Customization][OpenAPI Runtime Error Payload Customization]
- [OpenAPI Guide][OpenAPI Guide]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Additional and Pattern Properties](./25.Additional-Pattern-Properties)
Next: [Razor](../11.razor/index)

[10.26-OpenAPI-Custom-Error-Handler.ps1]: /pwsh/tutorial/examples/10.26-OpenAPI-Custom-Error-Handler.ps1
[Add-KrOpenApiInfo]: /pwsh/cmdlets/Add-KrOpenApiInfo
[Set-KrOpenApiErrorSchema]: /pwsh/cmdlets/Set-KrOpenApiErrorSchema
[Set-KrPowerShellErrorResponse]: /pwsh/cmdlets/Set-KrPowerShellErrorResponse
[OpenApiPath]: /pwsh/cmdlets/OpenApiPath
[OpenApiRequestBody]: /pwsh/cmdlets/OpenApiRequestBody
[OpenApiResponse]: /pwsh/cmdlets/OpenApiResponse
[OpenApiSchemaComponent]: /pwsh/cmdlets/OpenApiSchemaComponent
[Add-KrOpenApiRoute]: /pwsh/cmdlets/Add-KrOpenApiRoute
[Build-KrOpenApiDocument]: /pwsh/cmdlets/Build-KrOpenApiDocument
[Test-KrOpenApiDocument]: /pwsh/cmdlets/Test-KrOpenApiDocument
[Add-KrApiDocumentationRoute]: /pwsh/cmdlets/Add-KrApiDocumentationRoute
[OpenAPI Runtime Error Payload Customization]: /guides/openapi#openapi-focused-runtime-error-payload-customization
[OpenAPI Guide]: /guides/openapi
