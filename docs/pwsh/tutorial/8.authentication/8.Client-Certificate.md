---
title: Client Certificate
parent: Authentication
nav_order: 8
---

# Client Certificate

Authenticate users via client TLS certificates.

Client certificate authentication is a secure way to verify the identity of clients connecting to your server using X.509 certificates. This is particularly useful in scenarios where you need mutual TLS (mTLS) authentication.

## Key Features

- **X.509 Certificate Validation**: Automatically validates client certificates
- **Flexible Validation Options**: Configure allowed certificate types (Chained, SelfSigned, or All)
- **Certificate Use Validation**: Ensure certificates are valid for client authentication
- **Validity Period Checks**: Validate that certificates are within their validity period
- **Revocation Checking**: Support for online and offline certificate revocation checks
- **Claims-Based Identity**: Certificates automatically generate claims including subject, issuer, thumbprint, and serial number

## Basic Example

```powershell
# Import the Kestrun module
Import-Module Kestrun

# Create a new server
$server = New-KrServer -Name 'Certificate Auth Server'

# Configure HTTPS endpoint with client certificate requirement
Add-KrEndpoint -Https -Port 5001 -RequireClientCertificate

# Add client certificate authentication
Add-KrClientCertificateAuthentication -ValidateCertificateUse -ValidateValidityPeriod

# Add a protected route
Add-KrMapRoute -Verbs Get -Pattern '/secure/hello' -RequireAuth {
    $cert = $Context.Connection.ClientCertificate
    Write-KrJsonResponse @{
        message = "Hello from client certificate authentication"
        subject = $cert.Subject
        issuer = $cert.Issuer
        thumbprint = $cert.Thumbprint
    }
}

# Start the server
Start-KrServer
```

## Configuration Options

### AllowedCertificateTypes

Control which types of certificates are accepted:

```powershell
# Allow only chained (CA-signed) certificates
Add-KrClientCertificateAuthentication -AllowedCertificateTypes Chained

# Allow only self-signed certificates
Add-KrClientCertificateAuthentication -AllowedCertificateTypes SelfSigned

# Allow all certificate types (default)
Add-KrClientCertificateAuthentication -AllowedCertificateTypes All
```

### Certificate Validation

Enable various validation checks:

```powershell
Add-KrClientCertificateAuthentication `
    -ValidateCertificateUse `        # Validate certificate has client auth usage
    -ValidateValidityPeriod `        # Check certificate is not expired
    -RevocationMode Online           # Check certificate revocation status
```

### Revocation Checking

Configure certificate revocation checking:

```powershell
# No revocation checking (default)
Add-KrClientCertificateAuthentication -RevocationMode NoCheck

# Online revocation checking (OCSP/CRL)
Add-KrClientCertificateAuthentication -RevocationMode Online

# Offline revocation checking (cached CRLs)
Add-KrClientCertificateAuthentication -RevocationMode Offline
```

## Testing Client Certificate Authentication

To test client certificate authentication, you'll need:

1. A server certificate for HTTPS
2. A client certificate
3. A client that can present the certificate

### Create Test Certificates

For testing purposes, you can use self-signed certificates:

```powershell
# Create a server certificate
$serverCert = New-KrSelfSignedCertificate -DnsNames 'localhost' -Exportable
Export-KrCertificate -Certificate $serverCert -FilePath 'server.pfx' `
    -IncludePrivateKey -Format pfx -Password (ConvertTo-SecureString -String 'test' -AsPlainText -Force)

# Create a client certificate
$clientCert = New-KrSelfSignedCertificate -DnsNames 'test-client' -Exportable
Export-KrCertificate -Certificate $clientCert -FilePath 'client.pfx' `
    -IncludePrivateKey -Format pfx -Password (ConvertTo-SecureString -String 'test' -AsPlainText -Force)
```

**Note:** For production environments, client certificates should be issued by a trusted Certificate Authority (CA). Self-signed certificates are only suitable for development and testing.

### Test with PowerShell

```powershell
# Import the client certificate
$clientCert = Import-PfxCertificate -FilePath 'client.pfx' -CertStoreLocation 'Cert:\CurrentUser\My' `
    -Password (ConvertTo-SecureString -String 'test' -AsPlainText -Force)

# Make a request with the client certificate
Invoke-RestMethod -Uri 'https://localhost:5001/secure/hello' `
    -Certificate $clientCert -SkipCertificateCheck
```

## Claims Issued

The client certificate authentication handler automatically creates the following claims:

- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier`: Certificate subject
- `http://schemas.xmlsoap.org/ws/2005/05/identity/claims/name`: Certificate subject
- `thumbprint`: Certificate thumbprint
- `issuer`: Certificate issuer
- `serialnumber`: Certificate serial number

## Advanced Scenarios

### Using Custom Trust Store

```powershell
# Create options with custom trust store
$options = [Kestrun.Authentication.ClientCertificateAuthenticationOptions]::new()

# Add trusted CA certificates
$options.CustomTrustStore = [System.Security.Cryptography.X509Certificates.X509Certificate2Collection]::new()
$options.CustomTrustStore.Add($caCertificate)

# Configure the server
Add-KrClientCertificateAuthentication -Options $options
```

### Combining with Other Authentication

You can combine client certificate authentication with other schemes:

```powershell
# Add multiple authentication schemes
Add-KrClientCertificateAuthentication -AuthenticationScheme 'Certificate'
Add-KrBasicAuthentication -AuthenticationScheme 'Basic' -ScriptBlock { param($username, $password) $true }

# Routes can require specific schemes or any authenticated user
Add-KrMapRoute -Verbs Get -Pattern '/cert-only' -RequireAuth -AuthSchemes 'Certificate' { ... }
Add-KrMapRoute -Verbs Get -Pattern '/any-auth' -RequireAuth { ... }
```

## Security Considerations

1. **Always use HTTPS**: Client certificate authentication should only be used over HTTPS
2. **Validate Certificate Use**: Enable `-ValidateCertificateUse` to ensure certificates have the correct usage
3. **Check Revocation**: Enable revocation checking in production environments
4. **Restrict Certificate Types**: Use `-AllowedCertificateTypes Chained` in production to only accept CA-signed certificates
5. **Secure Private Keys**: Ensure server and client private keys are properly protected

## Troubleshooting

### Certificate Not Sent by Client

If the client certificate is not being sent:
1. Verify the endpoint requires client certificates: `Add-KrEndpoint -RequireClientCertificate`
2. Check the client certificate is installed and accessible
3. Ensure the certificate has a private key

### Certificate Validation Fails

If certificate validation fails:
1. Check certificate validity period
2. Verify certificate has client authentication extended key usage (if `-ValidateCertificateUse` is enabled)
3. Ensure the certificate chain is trusted
4. Check revocation status (if revocation checking is enabled)

## References

- [ASP.NET Core Certificate Authentication](https://learn.microsoft.com/en-us/aspnet/core/security/authentication/certauth)
- [X.509 Certificates](https://en.wikipedia.org/wiki/X.509)
- [Mutual TLS](https://en.wikipedia.org/wiki/Mutual_authentication#mTLS)

---

### Previous / Next

{: .fs-4 .fw-500}

- Previous: [Claims & Policies][Prev]
- Next: [OpenID Connect (Okta)][Next]

[Prev]: ./7.Claims-Policies
[Next]: ./9.OpenID-Connect-Okta
