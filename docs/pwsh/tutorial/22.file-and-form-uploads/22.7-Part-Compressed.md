---
layout: default
parent: File and Form Uploads
title: Part-level compression
nav_order: 7
---

# Part-level compression

Decompress individual multipart parts using per-part Content-Encoding.

## Full source

File: [`pwsh/tutorial/examples/22-file-and-form-uploads/22.7-part-compressed.ps1`][22.7-part-compressed.ps1]

```powershell
{% include examples/pwsh/22.7-part-compressed.ps1 %}
```

## Step-by-step

1. Logger: Enable console logging.
2. Server: Create the host and bind a listener.
3. Options: Enable per-part decompression and set decompressed limits.
4. Route: Add `/part-compressed` with `Add-KrFormRoute`.
5. Response: Return metadata for the decoded file part.

## Try it

```powershell
$client = [System.Net.Http.HttpClient]::new()
$content = [System.Net.Http.MultipartFormDataContent]::new()
$raw = [System.Text.Encoding]::UTF8.GetBytes('compressed-part')
$ms = [System.IO.MemoryStream]::new()
$gzip = [System.IO.Compression.GZipStream]::new($ms, [System.IO.Compression.CompressionMode]::Compress, $true)
$gzip.Write($raw, 0, $raw.Length)
$gzip.Dispose()
$compressed = $ms.ToArray()
$part = [System.Net.Http.ByteArrayContent]::new($compressed)
$part.Headers.ContentType = [System.Net.Http.Headers.MediaTypeHeaderValue]::Parse('text/plain')
$part.Headers.ContentEncoding.Add('gzip')
$content.Add($part,'file','payload.txt')
$client.PostAsync('http://127.0.0.1:5000/part-compressed', $content).Result.Content.ReadAsStringAsync().Result
```

```bash
printf 'compressed-part' > payload.txt
gzip -c payload.txt > payload.gz
curl -F "file=@payload.gz;type=text/plain;headers=Content-Encoding: gzip" http://127.0.0.1:5000/part-compressed
```

## Expected output

```json
{
  "fileName": "payload.txt",
  "length": 15,
  "sha256": "..."
}
```

## Notes

- Optional: Part-level decompression is disabled by default.
- Limits: `MaxDecompressedBytesPerPart` protects against decompression bombs.
- Logging: Part encoding decisions are logged via `host.Logger`.

## Troubleshooting

- No decompression: Ensure the part has `Content-Encoding: gzip` and `EnablePartDecompression` is enabled in options.
- 415 / Unsupported Content-Encoding: Ensure the part encoding is one of the allowed encodings.

## References

- [Add-KrFormRoute][Add-KrFormRoute]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Write-KrJsonResponse][Write-KrJsonResponse]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Request-level compression](./22.6-Request-Compressed)
Next: [OpenAPI: basic multipart upload](./22.8-Basic-Multipart-OpenAPI)

[22.7-part-compressed.ps1]: /pwsh/tutorial/examples/22-file-and-form-uploads/22.7-part-compressed.ps1
[Add-KrFormRoute]: /pwsh/cmdlets/Add-KrFormRoute
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
