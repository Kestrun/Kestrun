---
layout: default
parent: File and Form Uploads
title: Request-level compression
nav_order: 6
---

# Request-level compression

Enable ASP.NET Core RequestDecompression middleware for gzip request bodies.

## Full source

File: [`pwsh/tutorial/examples/22-file-and-form-uploads/22.6-request-compressed.ps1`][22.6-request-compressed.ps1]

```powershell
{% include examples/pwsh/22.6-request-compressed.ps1 %}
```

## Step-by-step

1. Logger: Enable console logging.
2. Server: Create the host and bind a listener.
3. Middleware: Add `Add-KrRequestDecompressionMiddleware` for gzip.
4. Options: Configure upload storage and hashing.
5. Route: Add `/upload` with `Add-KrFormRoute`.
6. Response: Return stored file metadata.

## Try it

```powershell
$boundary = 'req-boundary'
$body = @(
    "--$boundary",
    "Content-Disposition: form-data; name=note",
    "",
    "compressed",
    "--$boundary",
    "Content-Disposition: form-data; name=file; filename=hello.txt",
    "Content-Type: text/plain",
    "",
    "hello",
    "--$boundary--",
    ""
) -join "`r`n"
$bytes = [System.Text.Encoding]::UTF8.GetBytes($body)

$ms = [System.IO.MemoryStream]::new()
try {
  $gzip = [System.IO.Compression.GZipStream]::new($ms, [System.IO.Compression.CompressionMode]::Compress, $true)
  try {
    $gzip.Write($bytes, 0, $bytes.Length)
  } finally {
    $gzip.Dispose()
  }

  # Ensure we send a raw byte[] body (not an enumerated Object[] of bytes)
  [byte[]]$compressed = $ms.ToArray()
} finally {
  $ms.Dispose()
}

Invoke-WebRequest -Method Post -Uri 'http://127.0.0.1:5000/upload' -ContentType "multipart/form-data; boundary=$boundary" -Headers @{ 'Content-Encoding'='gzip' } -Body $compressed
```

```bash
cat > payload.txt <<'EOF'
--req-boundary
Content-Disposition: form-data; name=note

compressed
--req-boundary
Content-Disposition: form-data; name=file; filename=hello.txt
Content-Type: text/plain

hello
--req-boundary--
EOF

gzip -c payload.txt | curl -X POST \
  -H "Content-Encoding: gzip" \
  -H "Content-Type: multipart/form-data; boundary=req-boundary" \
  --data-binary @- \
  http://127.0.0.1:5000/upload
```

## Expected output

```json
{
  "count": 1,
  "files": [
    { "name": "file", "fileName": "hello.txt", "length": 5, "sha256": "..." }
  ]
}
```

## Notes

- Middleware: Request decompression must be enabled before parsing compressed bodies.
- Limits: `MaxRequestBodyBytes` still applies to decompressed size at the server level.
- Logging: Request-level compression status is logged via `host.Logger`.
- PowerShell: If you build a helper function that *returns* a `byte[]`, ensure it returns a single `byte[]` object (avoid enumeration into `Object[]`).

## Troubleshooting

- 415 / Unsupported Content-Type: Ensure the request `Content-Type` is `multipart/form-data; boundary=...`.
- 500 / Decompression errors: Ensure `Add-KrRequestDecompressionMiddleware -AllowedEncoding gzip` is enabled and you send valid
gzip bytes with `Content-Encoding: gzip`.

## References

- [Add-KrRequestDecompressionMiddleware][Add-KrRequestDecompressionMiddleware]
- [Add-KrFormRoute][Add-KrFormRoute]
- [New-KrServer][New-KrServer]
- [Add-KrEndpoint][Add-KrEndpoint]
- [Enable-KrConfiguration][Enable-KrConfiguration]
- [Write-KrJsonResponse][Write-KrJsonResponse]

---

### Previous / Next

{: .fs-4 .fw-500}

Previous: [Nested multipart/mixed](./22.5-Nested-Multipart)
Next: [Part-level compression](./22.7-Part-Compressed)

[22.6-request-compressed.ps1]: /pwsh/tutorial/examples/22-file-and-form-uploads/22.6-request-compressed.ps1
[Add-KrRequestDecompressionMiddleware]: /pwsh/cmdlets/Add-KrRequestDecompressionMiddleware
[Add-KrFormRoute]: /pwsh/cmdlets/Add-KrFormRoute
[New-KrServer]: /pwsh/cmdlets/New-KrServer
[Add-KrEndpoint]: /pwsh/cmdlets/Add-KrEndpoint
[Enable-KrConfiguration]: /pwsh/cmdlets/Enable-KrConfiguration
[Write-KrJsonResponse]: /pwsh/cmdlets/Write-KrJsonResponse
