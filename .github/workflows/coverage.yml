name: Coverage
permissions:
  contents: read

on:
  pull_request:
    branches: [ main ]
    types: [ closed ]          # fires when PR closes; we'll check merged==true
  push:
    branches: [ main ]         # for direct merges pushed to main
  merge_group:                 # optional: supports GitHub Merge Queue
    types: [ checks_requested ]
  workflow_dispatch: {}


concurrency:
  group: coverage-${{ github.ref }}
  cancel-in-progress: true

jobs:
  merge-guard:
    name: "gate: run only on merges or main pushes"
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.check.outputs.proceed }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - id: check
        shell: bash
        run: |
          set -e
          echo "proceed=false" >> "$GITHUB_OUTPUT"

          # Merge Queue
          if [[ "${{ github.event_name }}" == "merge_group" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # PR closed & merged
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Any direct push to main (merge commit OR single-parent commit)
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "proceed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi


    # --- C# coverage (one canonical env uploads) ---
  csharp-coverage:
    name: C# coverage (ubuntu-24.04, .NET 8/9)
    needs: [merge-guard]
    if: ${{ needs.merge-guard.outputs.proceed == 'true' }}
    runs-on: ubuntu-24.04
    env:
      POWERSHELL_DISTRIBUTION_CHANNEL: GitHub-Actions
      DOTNET_VERBOSITY: minimal
    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493  # v5 pin

      - name: üß∞ Setup .NET 8 & 9
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d  # v4.3.1 pin
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      # Non-interactive PSResource install (trust PSGallery)
      - name: üß∞ Install Invoke-Build & Pester (trusted, non-interactive)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Scope CurrentUser -Force -SkipPublisherCheck -AllowClobber
          }
          Import-Module Microsoft.PowerShell.PSResourceGet -Force
          $repo = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $repo) {
            Register-PSResourceRepository -Name PSGallery -Uri 'https://www.powershellgallery.com/api/v3/index.json' -Trusted
          } elseif (-not $repo.Trusted) {
            Set-PSResourceRepository -Name PSGallery -Trusted
          }
          Install-PSResource -Repository PSGallery -TrustRepository -Scope CurrentUser -Name 'InvokeBuild','Pester'
          Get-Module Pester -ListAvailable | Select Name,Version,Path

      - name: üì¶ Restore
        shell: pwsh
        run: Invoke-Build Restore -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üîß Build
        shell: pwsh
        run: Invoke-Build Build -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üß™ Test (.NET) with coverage (Cobertura, Debug)
        shell: pwsh
        run: |
          # If your Coverage task accepts a framework parameter, pass it explicitly:
          # Invoke-Build Coverage -Framework net9.0
          Invoke-Build Coverage

      - name: üîç Sanity check Cobertura (C#)
        run: |
          test -s coverage/csharp.net9.0.cobertura.xml || (echo "Cobertura is empty"; exit 1)
          grep -Eo '<class name="[^"]+"' coverage/csharp.net9.0.cobertura.xml | head -5 || true

      - name: ‚òÅÔ∏è Upload C# to Coveralls (parallel)
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: coverage/csharp.net9.0.cobertura.xml
          format: cobertura
          parallel: true
          flag-name: csharp
          debug: true


  # --- PowerShell coverage (one canonical env uploads) ---
  pwsh-coverage:
    name: PowerShell coverage (ubuntu-24.04)
    needs: [merge-guard]
    if: ${{ needs.merge-guard.outputs.proceed == 'true' }}
    runs-on: ubuntu-24.04
    env:
      POWERSHELL_DISTRIBUTION_CHANNEL: GitHub-Actions
      PESTER_VERBOSITY: Normal
      DOTNET_VERBOSITY: minimal
    steps:
      - name: üõéÔ∏è Checkout
        uses: actions/checkout@v5

      - name: üß∞ Setup .NET 8 & 9
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d  # v4.3.1 pin
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      # Non-interactive PSResource install (trust PSGallery)
      - name: üß∞ Install Invoke-Build & Pester (trusted, non-interactive)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Scope CurrentUser -Force -SkipPublisherCheck -AllowClobber
          }
          Import-Module Microsoft.PowerShell.PSResourceGet -Force
          $repo = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $repo) {
            Register-PSResourceRepository -Name PSGallery -Uri 'https://www.powershellgallery.com/api/v3/index.json' -Trusted
          } elseif (-not $repo.Trusted) {
            Set-PSResourceRepository -Name PSGallery -Trusted
          }
          Install-PSResource -Repository PSGallery -TrustRepository -Scope CurrentUser -Name 'InvokeBuild','Pester'
          Get-Module Pester -ListAvailable | Select Name,Version,Path

      - name: üì¶ Restore
        shell: pwsh
        run: Invoke-Build Restore -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üîß Build
        shell: pwsh
        run: Invoke-Build Build -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üß™ Test (Pester) with coverage (JaCoCo, Pester 5)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          $cfg = New-PesterConfiguration
          $cfg.Run.Path = @('tests/PowerShell.Tests')
          $cfg.Run.Exit = $true
          $cfg.Output.Verbosity = $Env:PESTER_VERBOSITY
          $cfg.CodeCoverage.Enabled = $true
          $cfg.CodeCoverage.Path = @('src/PowerShell/Kestrun/*.psm1','src/PowerShell/Kestrun/*.ps1')
          $cfg.CodeCoverage.OutputFormat = 'JaCoCo'
          $cfg.CodeCoverage.OutputPath = './coverage/powershell.jacoco.xml'
          Invoke-Pester -Configuration $cfg

      - name: ‚òÅÔ∏è Upload PowerShell to Coveralls (parallel)
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          file: ./coverage/powershell.jacoco.xml
          parallel: true
          flag-name: powershell

  # --- Finalize (must run AFTER all uploads) ---
  coveralls-finish:
    name: Finalize Coveralls
    runs-on: ubuntu-24.04
    needs: [merge-guard, csharp-coverage, pwsh-coverage]   # include the gate too
    if: ${{ needs.merge-guard.outputs.proceed == 'true' && always() }}
    steps:
      - name: ‚úÖ Tell Coveralls we're done
        uses: coverallsapp/github-action@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          parallel-finished: true
          carryforward: "csharp,powershell"

  # --- Report generation (one canonical env uploads) ---
  report-generator:
    needs: [merge-guard]
    if: ${{ needs.merge-guard.outputs.proceed == 'true' }}
    runs-on: ubuntu-latest
    name: report-generator
    env:
      POWERSHELL_DISTRIBUTION_CHANNEL: GitHub-Actions
      DOTNET_VERBOSITY: minimal
      DEST_REPO: Kestrun/coverage
      DEST_PATH: docs
      RESET_COVERAGE_HISTORY: "false"

    steps:
      # Source repo (no creds persisted)
      - name: üõéÔ∏è Checkout (source repo)
        uses: actions/checkout@ff7abcd0c3c05ccf6adc123a8cd1fd4fb30fb493
        with:
          persist-credentials: false

      - name: üß∞ Setup .NET 8 & 9
        uses: actions/setup-dotnet@d4c94342e560b34958eacfc5d055d21461ed1c5d
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      # Non-interactive PSResource install (trust PSGallery)
      - name: üß∞ Install Invoke-Build & Pester (trusted, non-interactive)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Module -ListAvailable -Name Microsoft.PowerShell.PSResourceGet)) {
            Install-Module -Name Microsoft.PowerShell.PSResourceGet -Scope CurrentUser -Force -SkipPublisherCheck -AllowClobber
          }
          Import-Module Microsoft.PowerShell.PSResourceGet -Force
          $repo = Get-PSResourceRepository -Name PSGallery -ErrorAction SilentlyContinue
          if (-not $repo) {
            Register-PSResourceRepository -Name PSGallery -Uri 'https://www.powershellgallery.com/api/v3/index.json' -Trusted
          } elseif (-not $repo.Trusted) {
            Set-PSResourceRepository -Name PSGallery -Trusted
          }
          Install-PSResource -Repository PSGallery -TrustRepository -Scope CurrentUser -Name 'InvokeBuild','Pester'
          Get-Module Pester -ListAvailable | Select Name,Version,Path

      # Coverage site repo (we'll set remote with PAT ourselves)
      - name: üì• Checkout coverage site repo (for in-place output + history)
        uses: actions/checkout@v5
        with:
          repository: ${{ env.DEST_REPO }}
          path: coverage-site
          fetch-depth: 0
          persist-credentials: false

      - name: üîê Configure PAT on coverage remote
        run: |
          set -euo pipefail
          cd coverage-site
          git remote set-url origin "https://x-access-token:${{ secrets.COVERAGE_REPO_PAT }}@github.com/${{ env.DEST_REPO }}.git"
          git remote -v

      - name: üì¶ Restore
        shell: pwsh
        run: Invoke-Build Restore -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üîß Build
        shell: pwsh
        run: Invoke-Build Build -DotNetVerbosity $Env:DOTNET_VERBOSITY

      - name: üß™ Test (.NET + PS) & Generate report (into site repo, with history)
        shell: pwsh
        env:
          SITE_DIR: ${{ github.workspace }}/coverage-site/${{ env.DEST_PATH }}
          HISTORY_DIR: ${{ github.workspace }}/coverage-site/${{ env.DEST_PATH }}/history
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path $env:SITE_DIR,$env:HISTORY_DIR | Out-Null

          ./Utility/Build-Coverage.ps1 `
            -Framework "net9.0" `
            -Configuration "Release" `
            -TestProject ".\tests\CSharp.Tests\Kestrun.Tests\KestrunTests.csproj" `
            -CoverageDir ".\coverage" `
            -PesterPath ".\tests\PowerShell.Tests\Kestrun.Tests" `
            -ReportGenerator `
            -ReportDir $env:SITE_DIR `
            -HistoryDir $env:HISTORY_DIR `
            -ResetHistory:($env:RESET_COVERAGE_HISTORY  -eq 'true')

          New-Item -ItemType File -Path (Join-Path $env:SITE_DIR '.nojekyll') -Force | Out-Null

      # ‚úÖ Commit & push from the coverage repo itself (skip on PRs from forks)
      - name: ‚úÖ Commit & push if changed
        if: github.event_name != 'pull_request'
        run: |
          set -euo pipefail
          cd coverage-site
          git status --porcelain
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit."
          else
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git commit -m "Update coverage (C# + PowerShell) from ${GITHUB_REPOSITORY}@${GITHUB_SHA} on $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push origin "$CURRENT_BRANCH"
          fi

      - name: üßë‚Äçüíª Live SSH (only if failed and debug enabled)
        if: ${{ failure() }}
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true

